<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Filter</title>
    <style>

.device-selection {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.device-select {
    padding: 0.5rem;
    border-radius: 0.375rem;
    background-color: #374151;
    color: #E5E7EB;
    border: 1px solid #4B5563;
}

.device-params {
    display: flex;
    gap: 1rem;
    justify-content: center;
    color: #D1D5DB;
}

.device-params select {
    padding: 0.25rem;
    border-radius: 0.375rem;
    background-color: #374151;
    color: #E5E7EB;
    border: 1px solid #4B5563;
    margin-left: 0.5rem;
}
        /* Base styles */
        body {
            margin: 0;
            padding: 0;
            background-color: #111827;
            color: #E5E7EB;
            font-family: futura, sans-serif;
        }
        
        .container {
            max-width: 42rem;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .title {
            font-size: 2.25rem;
            font-weight: 300;
            letter-spacing: 0.1em;
            text-align: center;
            margin-bottom: 2rem;
            color: #D1D5DB;
        }
        
        .controls {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        button {
            background-color: #374151;
            color: #E5E7EB;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        button:hover {
            background-color: #4B5563;
        }
        
        .values {
            text-align: center;
            margin-top: 1rem;
            color: #D1D5DB;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">AUDIO FILTER</h1>
        
        <svg id="filter-interface" viewBox="0 0 400 200" style="width: 100%;">
            <!-- Background panel -->
            <rect x="20" y="20" width="360" height="160" rx="8" fill="#424242"/>
            
            <!-- Bandwidth Control -->
            <g transform="translate(100,100)" class="knob" id="bandwidth-knob">
                <circle r="30" fill="#2D2D2D"/>
                <rect x="-2" y="-23" width="4" height="16" fill="#E8D5C4" id="bandwidth-indicator"/>
                <text x="-35" y="-35" text-anchor="middle" fill="#D1D5DB" font-size="8">50Hz</text>
                <text x="0" y="-40" text-anchor="middle" fill="#D1D5DB" font-size="8">250Hz</text>
                <text x="35" y="-35" text-anchor="middle" fill="#D1D5DB" font-size="8">500Hz</text>
                <text y="50" text-anchor="middle" fill="#D1D5DB" font-size="12" style="letter-spacing: 0.1em;">BANDWIDTH</text>
            </g>
            
            <!-- Center Frequency Control -->
            <g transform="translate(300,100)" class="knob" id="center-knob">
                <circle r="30" fill="#2D2D2D"/>
                <rect x="-2" y="-23" width="4" height="16" fill="#E8D5C4" id="center-indicator"/>
                <text x="-35" y="-35" text-anchor="middle" fill="#D1D5DB" font-size="8">660Hz</text>
                <text x="0" y="-40" text-anchor="middle" fill="#D1D5DB" font-size="8">700Hz</text>
                <text x="35" y="-35" text-anchor="middle" fill="#D1D5DB" font-size="8">740Hz</text>
                <text y="50" text-anchor="middle" fill="#D1D5DB" font-size="12" style="letter-spacing: 0.1em;">CENTRE</text>
            </g>
            
            <!-- Corner screws -->
            <circle cx="30" cy="30" r="4" fill="#1A1A1A"/>
            <circle cx="370" cy="30" r="4" fill="#1A1A1A"/>
            <circle cx="30" cy="170" r="4" fill="#1A1A1A"/>
            <circle cx="370" cy="170" r="4" fill="#1A1A1A"/>
        </svg>
        
        <div class="values" id="values-display">
            Bandwidth: 250Hz | Center: 700Hz
        </div>
        
        <div class="controls">
            <button onclick="startAudio()">Start Audio</button>
            <button onclick="stopAudio()">Stop Audio</button>
            <div class="device-selection">
                <select id="device-select" class="device-select">
                    <option value="">Select Audio Device</option>
                </select>
                <div class="device-params">
                    <label>
                        Buffer Size:
                        <select id="buffer-size">
                            <option value="128">128 (Lowest latency)</option>
                            <option value="256" selected>256 (Balanced)</option>
                            <option value="512">512 (More stable)</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        
// Add this to the loadDevices function in your JavaScript
async function loadDevices() {
    try {
        console.log('Fetching audio devices...');
        const response = await fetch('/get_devices');
        const data = await response.json();
        console.log('Received device data:', data);
        
        const deviceSelect = document.getElementById('device-select');
        deviceSelect.innerHTML = '<option value="">Select Audio Device</option>';
        
        if (data.status === 'success' && data.devices) {
            console.log(`Found ${data.devices.length} devices`);
            
            data.devices.forEach(device => {
                console.log('Adding device:', device);
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} (${device.inputs}in/${device.outputs}out)`;
                deviceSelect.appendChild(option);
            });
        } else {
            console.error('Error loading devices:', data.message);
            deviceSelect.innerHTML += '<option disabled>No devices found</option>';
        }
    } catch (error) {
        console.error('Error loading devices:', error);
        const deviceSelect = document.getElementById('device-select');
        deviceSelect.innerHTML += '<option disabled>Error loading devices</option>';
    }
}

async function selectDevice() {
    const deviceId = document.getElementById('device-select').value;
    const bufferSize = document.getElementById('buffer-size').value;
    
    if (!deviceId) return;
    
    try {
        const response = await fetch('/select_device', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: parseInt(deviceId),
                buffer_size: parseInt(bufferSize)
            })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            console.log('Device selected:', data.current_params);
        } else {
            console.error('Error selecting device:', data.message);
        }
    } catch (error) {
        console.error('Error selecting device:', error);
    }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', loadDevices);
document.getElementById('device-select').addEventListener('change', selectDevice);
document.getElementById('buffer-size').addEventListener('change', selectDevice);

        // Current parameter values
        let currentParams = {
            bandwidth: 250,
            centerFreq: 700
        };
        
        // Drag state
        let isDragging = null;
        let startAngle = 0;
        
        // Get elements
        const bandwidthKnob = document.getElementById('bandwidth-knob');
        const centerKnob = document.getElementById('center-knob');
        const bandwidthIndicator = document.getElementById('bandwidth-indicator');
        const centerIndicator = document.getElementById('center-indicator');
        const valuesDisplay = document.getElementById('values-display');
        
        function updateKnobRotation(knob, angle) {
            const indicator = knob === 'bandwidth' ? bandwidthIndicator : centerIndicator;
            indicator.setAttribute('transform', `rotate(${angle})`);
        }
        
        function calculateValue(angle, knob) {
            if (knob === 'bandwidth') {
                return Math.round(50 + ((angle + 45) / 90) * (500 - 50));
            } else {
                return Math.round(660 + ((angle + 45) / 90) * (740 - 660));
            }
        }
        
        function handleMouseDown(e, knob) {
            isDragging = knob;
            const rect = e.target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        }
        
        function handleMouseMove(e) {
            if (!isDragging) return;
            
            const rect = e.target.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
            
            let rotation = ((angle - startAngle) * 180 / Math.PI);
            rotation = Math.max(-45, Math.min(45, rotation));
            
            updateKnobRotation(isDragging, rotation);
            
            const value = calculateValue(rotation, isDragging);
            if (isDragging === 'bandwidth') {
                currentParams.bandwidth = value;
            } else {
                currentParams.centerFreq = value;
            }
            
            updateDisplay();
        }
        
        function handleMouseUp() {
            if (isDragging) {
                updateParams();
                isDragging = null;
            }
        }
        
        function updateDisplay() {
            valuesDisplay.textContent = `Bandwidth: ${currentParams.bandwidth}Hz | Center: ${currentParams.centerFreq}Hz`;
        }
        
        async function updateParams() {
            try {
                const response = await fetch('/update_params', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bandwidth: currentParams.bandwidth,
                        center_freq: currentParams.centerFreq
                    })
                });
                const data = await response.json();
                console.log('Parameters updated:', data);
            } catch (error) {
                console.error('Error updating parameters:', error);
            }
        }
        
        async function startAudio() {
            try {
                const response = await fetch('/start', { method: 'POST' });
                const data = await response.json();
                console.log(data.message);
            } catch (error) {
                console.error('Error starting audio:', error);
            }
        }
        
        async function stopAudio() {
            try {
                const response = await fetch('/stop', { method: 'POST' });
                const data = await response.json();
                console.log(data.message);
            } catch (error) {
                console.error('Error stopping audio:', error);
            }
        }
        
        // Add event listeners
        bandwidthKnob.addEventListener('mousedown', (e) => handleMouseDown(e, 'bandwidth'));
        centerKnob.addEventListener('mousedown', (e) => handleMouseDown(e, 'center'));
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    </script>
</body>
</html>